name: "Build and upload static Nix binaries"

on:
  push:
    paths:
      - flake.nix
      - flake.lock
      - nix-static-bins.nix
      - nixpkgs-darwin-static.nix

jobs:
# Support on hold pending upstream bintools fixes
#  precompile-bitrise:
#    name: Build macOS-specific derivations on Bitrise
#    runs-on: ubuntu-latest
#    if: github.ref == 'refs/heads/master'
#    steps:
#      - name: Wake up Bitrise
#        uses: llaine/hans-landa@0.5
#        with:
#          github_token: ${{ secrets.GITHUB_TOKEN }}
#          bitrise_app_slug: fa692dd0b84f09a9
#          bitrise_build_trigger_token: ${{ secrets.BITRISE_TOKEN }}
#          bitrise_workflow: primary
#      - name: Wait for Bitrise to complete
#        uses: fountainhead/action-wait-for-check@v1.1.0
#        with:
#          token: ${{ secrets.GITHUB_TOKEN }}
#          checkName: ci/bitrise/fa692dd0b84f09a9/push

  assemble-linux:
    name: Build Linux binaries and merge derivation
    runs-on: ubuntu-latest
#    needs: precompile-bitrise
    environment: Cachix
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Nix
        uses: cachix/install-nix-action@v20
      - name: Set up Cachix access
        uses: cachix/cachix-action@v12
        with:
          name: nix-wrap
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Install QEMU for AArch64 builds
        run: |
          apt-get -q -y update
          apt-get -q -y install qemu-user-static
          echo "extra-platforms = aarch64-linux" >> /etc/nix/nix.conf
      - run: nix build .#static-bins
